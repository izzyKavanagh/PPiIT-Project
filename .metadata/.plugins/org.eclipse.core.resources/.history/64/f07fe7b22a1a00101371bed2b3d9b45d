package Network;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

public class Topology {
	
	private Map<String, Map<String, Device>> networkTopology = new HashMap<>();
	private Map<String, Device> registeredDevices = new HashMap<String, Device>();
	private Map<String, List<String>> adjacencyList = new HashMap<String, List<String>>();
	private NetworkManager manager;

	public Topology(){}
	
	public void setNetworkManager(NetworkManager manager) {
		this.manager = manager;
	}
	
	public void registerDevice(Device device) {
		if (!networkTopology.containsKey(device.getName())) {
	        Map<String, Device> portMap = new HashMap<>();
	        for (int i = 0; i < device.getTotalPorts(); i++) {
	            portMap.put("Fa0/" + i, null);
	        }
	        networkTopology.put(device.getName(), portMap);
	        registeredDevices.put(device.getName(), device);
	    }
	}

	public boolean connectDevices(Device source, Device target) {
		Map<String, Device> sourcePorts = networkTopology.get(source.getName());
	    Map<String, Device> targetPorts = networkTopology.get(target.getName());
	    
	    if (sourcePorts == null || targetPorts == null) {
	        System.out.println("One or both devices are not registered.");
	        return false;
	    }
	    
	    String availableSourcePort = null;
	    String availableTargetPort = null;
	    
	    for (Map.Entry<String, Device> entry : sourcePorts.entrySet()) {
	        if (entry.getValue() == null) {
	        	availableSourcePort = entry.getKey();
	            break;
	        }
	    }

	    for (Map.Entry<String, Device> entry : targetPorts.entrySet()) {
	        if (entry.getValue() == null) {
	            availableTargetPort = entry.getKey();
	            break;
	        }
	    }
	    
	    if (availableSourcePort == null) {
	        System.out.println(source.getName() + " has no available ports.");
	        return false;
	    }
	    
	    if (availableTargetPort == null) {
	        System.out.println(target.getName() + " has no available ports.");
	        return false;
	    }
	    

	    if (source instanceof Switch sw) {
	        sw.updateMacTable(target, availableSourcePort);
	    }
	    
	    sourcePorts.put(availableSourcePort, target);
	    targetPorts.put(availableTargetPort, source);
	    
	    /*
	    if (source instanceof Switch && target instanceof Router) {
	        manager.connectSwitchToRouter((Switch) source, (Router) target);
	    } 
	    else if (source instanceof Device && target instanceof Switch) {
	        manager.connectDeviceToSwitch(source, (Switch) target);
	    } 
	    else if (source instanceof Switch && target instanceof Switch) {
	        manager.connectDeviceToSwitch((Switch) source, (Switch) target);  // connecting switch-to-switch, treat as connecting s2 to s1
	    }
	    else if (source instanceof Device && target instanceof Router) {
	        manager.connectDeviceToRouter(source, (Router) target);
	    }
	    else {
	        System.out.println("Unsupported connection type between " + source.getClass().getSimpleName() + " and " + target.getClass().getSimpleName());
	        return false;
	    }
	    */
	    
	    System.out.println(target.getName() + " connected to " + source.getName() + " on Port " + availableSourcePort);
	    updateAdjacencyList();
	    
	    return true;
	}
	
	public boolean disconnectDevices(Device source, Device target) {
		Map<String, Device> sourcePorts = networkTopology.get(source.getName());
	    Map<String, Device> targetPorts = networkTopology.get(target.getName());
	    
	    if (sourcePorts == null || targetPorts == null) {
	        System.out.println("One or both devices are not registered.");
	        return false;
	    }
	    
	    boolean disconnected = false;
	    
	    for (Map.Entry<String, Device> entry : sourcePorts.entrySet()) {
	        if (entry.getValue() != null && entry.getValue().equals(target)) {
	        	entry.setValue(null);
	        	disconnected = true;
	            System.out.println("Disconnected " + target.getName() + " from " + source.getName() + " at " + entry.getKey());
	            break;
	        }
	    }

	    for (Map.Entry<String, Device> entry : targetPorts.entrySet()) {
	        if (entry.getValue() != null && entry.getValue().equals(source)) {
	        	entry.setValue(null);
	        	disconnected = true;
	            System.out.println("Disconnected " + target.getName() + " from " + source.getName() + " at " + entry.getKey());
	            break;
	        }
	    }

	    /* add functionality to delete connections from mac table 
	    if (source instanceof Switch sw) {
	        sw.updateMacTable(target, availableSourcePort);
	    }
	    */
	    
	    if (!disconnected) {
	        System.out.println("No connection found between these devices.");
	    }
	    
	    updateAdjacencyList();
	    
	    return true;
	}
	
	public Map<String, List<String>> updateAdjacencyList(){
		// loop over key/value pairs in the topology map
		for (Map.Entry<String, Map<String, Device>> entry : networkTopology.entrySet()) {
			// get key AKA device's name
	        String deviceName = entry.getKey();
	        // extract value AKA connected device's name and ports and store it in a map for easier access
	        Map<String, Device> portMap = entry.getValue();

	        // create list to store adjacent devices in
	        List<String> adjacentDevices = new ArrayList<>();
	        
	        //loop through map storing topology map's value
	        for (Device connectedDevice : portMap.values()) {
	            if (connectedDevice != null) {
	            	// get name of connected device and store it in adjacency list
	            	adjacentDevices.add(connectedDevice.getName());
	            }
	        }
	        // add device and and its adjacent devices as key/values pair to adjacency list
	        adjacencyList.put(deviceName, adjacentDevices);
	    }
		
		return adjacencyList;
	}
	
	public void printAdjacencyList()
	{
		System.out.println("\nNetwork Topology Adjacency List:");
	    for (Map.Entry<String, List<String>> entry : adjacencyList.entrySet()) {
	        System.out.println(entry.getKey() + " -> " + entry.getValue());
	    }
	}

	public void printNetworkTopology() {
        System.out.println("\nNetwork Topology (Port Connections):");
        for (Map.Entry<String, Map<String, Device>> entry : networkTopology.entrySet()) {
            String deviceName = entry.getKey();
            Map<String, Device> ports = entry.getValue();
            System.out.println("\nDevice: " + deviceName);
            System.out.println("+--------+-------------------+");
            System.out.println("| Port   | Connected Device   |");
            System.out.println("+--------+-------------------+");
            for (Map.Entry<String, Device> portEntry : ports.entrySet()) {
                String port = portEntry.getKey();
                Device connectedDevice = portEntry.getValue();
                String connectedName = (connectedDevice != null) ? connectedDevice.getName() : "Empty";
                System.out.printf("| %-6s | %-17s |\n", port, connectedName);
            }
            System.out.println("+--------+-------------------+\n");
        }
    }

	public Map<String, Device> getTopology() {
		return registeredDevices;
	}
}
