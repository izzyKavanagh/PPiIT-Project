package Network;

import java.util.Map;

public class NetworkManager {
	private Topology topology;
	
	public NetworkManager(Topology topology) {
        this.topology = topology;
    }

    public void useStaticIpAllocation(Device device) {
    	
    	topology.updateAdjacencyList();
    	
    	Device connectedRouter = topology.checkIfConnected(device, Router.class);

    	if (connectedRouter != null && !(device instanceof Layer2Switch)) {
    	    Router router = (Router) connectedRouter;
    	    String ip = router.assignStaticIP(device.getMacAddress());
    	    device.ipAddress = ip;
    	    System.out.println(device.getName() + " assigned IP: " + ip);
    	}
    	
    	if(connectedRouter == null) 
    	{
    		System.out.println("ERROR: No router found on " + device.getName() + "'s network.");
    	}
    	
    }

    
    public void useDynamicIpAllocation(Device device, String poolName) {
    	
    	topology.updateAdjacencyList();
    	
    	Device connectedDHCP = topology.checkIfConnected(device, DHCPServer.class);

    	if (connectedDHCP != null && !(device instanceof Layer2Switch) && !(device instanceof Router)) 
    	{
    	    DHCPServer dhcpServer = (DHCPServer) connectedDHCP;
    	    String ip = dhcpServer.assignIp(poolName, device.getMacAddress());
    	    device.ipAddress = ip;
    	    System.out.println(device.getName() + " assigned IP: " + ip);
    	}
    	
    	if(connectedDHCP == null) 
    	{
    		System.out.println("ERROR: No DHCP server found on" + device.getName() + "'s network.");
    	}
    }
    
    public String findLayer3Device(Device device, int vlanId)
    {	
    	String gatewayIP;
    	
    	Device connectedSwitch = topology.checkIfConnected(device, Layer3Switch.class);
    	
    	Device connectedRouter = topology.checkIfConnected(device, Router.class);

    	if (connectedSwitch != null) 
    	{
    	    Layer3Switch layer3Switch = (Layer3Switch) connectedSwitch;
    	    Map<Integer, VLANInterface> vlanInterfaceMap = layer3Switch.getVLANInterfaces();
    	    VLANInterface vlanIntf = vlanInterfaceMap.get(vlanId);
    	    if(vlanIntf != null) 
    	    {
    	    	gatewayIP = vlanIntf.getIpAddress();
    	    	return gatewayIP;
    	    }
    	    if(vlanIntf == null) 
    	    {
    	    	System.out.println("No VLAN Interface set up for VLAN " + vlanId);
    	    	return null;
    	    }
    	}
    	else if(connectedRouter != null) 
    	{
    		System.out.println("ERROR: No DHCP server found on" + device.getName() + "'s network.");
    	}
    	else 
    	{
    		System.out.println("ERROR: No layer 3 device found on" + device.getName() + "'s network.");
    	}
    }

    public Topology getTopology() {
        return topology;
    }
}

